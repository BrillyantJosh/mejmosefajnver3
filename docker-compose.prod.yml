services:
  web:
    build: .
    container_name: mejmosefajn-web
    restart: unless-stopped
    env_file: .env
    expose:
      - "3001"
    volumes:
      - ./data:/app/data
      - ./server/uploads:/app/server/uploads
    environment:
      - VIRTUAL_HOST=new.mejmosefajn.org,app.mejmosefajn.org,new.lanalovesexeter.com,app.lanalovesexeter.com,app.lanaloves.us
      - VIRTUAL_PORT=3001
      - LETSENCRYPT_HOST=new.mejmosefajn.org,app.mejmosefajn.org,new.lanalovesexeter.com,app.lanalovesexeter.com,app.lanaloves.us
      - NODE_ENV=production
      - PORT=3001
    networks:
      - webproxy
      - backend

  whisper:
    image: fedirz/faster-whisper-server:latest-cpu
    container_name: mejmo-whisper
    restart: unless-stopped
    environment:
      - WHISPER__MODEL=Systran/faster-whisper-small
      - WHISPER__DEFAULT_LANGUAGE=sl
      - WHISPER__COMPUTE_TYPE=int8
    deploy:
      resources:
        limits:
          memory: 1200M
    volumes:
      - whisper_models:/root/.cache/huggingface
    networks:
      - backend

networks:
  webproxy:
    external: true
  backend:
    driver: bridge

volumes:
  whisper_models:
